<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sign Up | Honda Cub Atheneum</title>
    <link href="css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" href="css/normalize.css">
    <style>
        body, html {
            overflow: hidden;
            height: 100%;
            margin: 0;
        }
        .container-fluid {
            height: 100vh;
        }
        .right-side {
            background: url('images/5.jpg') no-repeat center center/cover;
            position: relative;
        }
        .right-side::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        .right-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }
        .left-side {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .signup-box {
            width: 100%;
            max-width: 450px;
            padding: 20px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Admin Verification Modal */
        .modal {
            display: none; /* Ensures it doesnâ€™t load automatically */
            position: fixed;
            z-index: 1050 !important;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 380px; /* Adjusted width */
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        /* Close button styling */
        .modal-card .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 22px;
            cursor: pointer;
            color: #555;
            background: none;
            border: none;
        }

        .modal-card h4 {
            margin-bottom: 15px;
            font-weight: bold;
            color: #333;
        }

        .modal-card input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        .modal-buttons {
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
        }

        .modal-buttons button {
            width: 48%; /* Ensures equal spacing */
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
        }

        .hidden {
            display: none !important;
            pointer-events: none; /* Prevent interaction */
        }

        .hidden.visible {
            display: block !important;
            pointer-events: auto; /* Allow interaction */
        }

        .form-control.is-invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5' stroke-width='1'/><path stroke-linecap='round' d='M5.8 3.6l.4 2.8M6 9.5v-2M3.5 10.5h5'/></svg>");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }

        .invalid-feedback {
            display: none;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }

        .form-control.is-invalid + .invalid-feedback {
            display: block;
        }

    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row h-100">
        <div class="col-md-6 left-side">
            <div class="signup-box">
                <h3 class="text-center">Sign Up</h3>
                <form id="signupForm" novalidate>
                    <div class="mb-3">
                        <label for="fullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="fullName" placeholder="Enter your full name" required>
                        <div class="invalid-feedback">Please enter your full name.</div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" placeholder="Enter your email" required>
                        <div class="invalid-feedback">Please enter a valid email address.</div>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone Number</label>
                        <input type="text" class="form-control" id="phone" placeholder="Enter your phone number" required>
                        <div class="invalid-feedback">Please enter a 10-digit phone number.</div>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Register as</label>
                        <select class="form-select" id="role" required>
                            <option value="">Select Role</option>
                            <option value="customer">Customer</option>
                            <option value="seller">Seller</option>
                        </select>
                        <div class="invalid-feedback">Please select a role.</div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" placeholder="Enter your password" required>
                        <div class="invalid-feedback">Password must be at least 6 characters long.</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm your password" required>
                        <div class="invalid-feedback">Passwords do not match.</div>
                    </div>
                    <!-- Checkbox to toggle visibility of passwords -->
                    <div class="mb-3">
                        <input type="checkbox" id="showPassword" class="form-check-input">
                        <label for="showPassword" class="form-check-label">Show Password</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-3" id="normalSignupBtn">Sign Up</button>
                    <!-- QR Code Download Button -->
                    <button type="button" class="btn btn-success w-100 mt-3 hidden" id="manualDownloadQR">
                        Download QR Code
                    </button>

                </form>



                <!-- Admin Signup Button -->
                <p class="text-center mt-3">
                    <button type="submit" class="btn btn-danger hidden" id="adminSignupFinalBtn">Admin Sign Up</button>
                </p>

                <p class="text-center mt-3">
                    <button class="btn btn-dark" id="adminSignupBtn">Sign Up as Admin</button>
                </p>

                <p class="text-center mt-3">Already have an account? <a href="login.html">Login</a></p>
                <p class="text-center mt-3"><button class="btn btn-warning"><a href="index.html" style="text-decoration: none; color: white;">Back</a></button></p>
            </div>
        </div>

        <div class="col-md-6 right-side">
            <div class="right-content">
                <h2>Join Us Today!</h2>
                <p>Create an account to explore Honda Cub spare parts and more.</p>
            </div>
        </div>
    </div>
</div>

<!-- Admin Signup Modal -->
<div class="modal" id="adminModal">
    <div class="modal-card">
        <button class="close-btn" id="closeModalBtn">&times;</button> <!-- Renamed ID -->
        <h4>Admin Verification</h4>
        <p>Enter the developer-provided password:</p>
        <input type="password" id="adminPass" class="form-control mb-3" placeholder="Enter admin password">
        <div class="modal-buttons">
            <button class="btn btn-primary" id="verifyAdmin">Verify</button>
            <button class="btn btn-secondary" id="cancelModal">Cancel</button> <!-- Renamed ID -->
        </div>
        <p id="errorMessage" class="text-danger hidden mt-2">Incorrect password! Try again.</p>
    </div>
</div>


<!-- QR Code Modal -->
<div class="modal" id="qrCodeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content text-center">
            <div class="modal-header">
                <h5 class="modal-title">Your QR Code</h5>
                <!-- Close button -->
                <button type="button" class="btn-close" id="closeQRCodeModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Scan this QR code to log in quickly.</p>
                <div id="qrCode"></div>
                <!-- QR Code Download Button -->
                <button class="btn btn-primary mt-3" id="downloadQR">Download QR Code</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="JQuery/jquery-3.7.1.min.js"></script>
<script>
    $(document).ready(function () {
        const developerAdminPassword = "123";

        const signupForm = $("#signupForm");
        const fullNameInput = $("#fullName");
        const emailInput = $("#email");
        const phoneInput = $("#phone");
        const roleSelect = $("#role");
        const passwordInput = $("#password");
        const confirmPasswordInput = $("#confirmPassword");

        // Function to display validation errors
        function displayError(inputElement, message) {
            inputElement.addClass("is-invalid");
            inputElement.next(".invalid-feedback").text(message).show();
        }

        // Function to clear validation errors
        function clearError(inputElement) {
            inputElement.removeClass("is-invalid");
            inputElement.next(".invalid-feedback").hide();
        }

        // Show Admin Verification Modal
        $("#adminSignupBtn").click(function () {
            $("#adminModal").css("display", "flex").hide().fadeIn();
        });

        // Close Modal Button and Cancel Button
        $("#closeModalBtn, #cancelModal").click(function () {
            $("#adminModal").fadeOut();
        });

        // Close QR Code Modal when clicking on the close button
        $("#closeQRCodeModal").click(function () {
            //$("#qrCodeModal").fadeOut();
            $("#qrCodeModal").fadeOut(function () {
                window.location.href = "login.html";
            });
        });

        // Verify Admin Password
        $("#verifyAdmin").click(function () {
            let enteredPassword = $("#adminPass").val();
            if (enteredPassword === developerAdminPassword) {
                $("#adminModal").fadeOut();

                // Hide normal signup button
                $("#normalSignupBtn").addClass("hidden");

                // Change heading to Admin Sign Up
                $(".signup-box h3").text("Admin Sign Up");

                // Set role to admin and disable changing it
                $("#role").html('<option value="admin">Admin</option>').prop("disabled", true);

                // Show only Admin Signup Button
                $("#adminSignupFinalBtn").removeClass("hidden");

                // Hide the "Sign Up as Admin" button to prevent reopening the modal
                $("#adminSignupBtn").addClass("hidden");

                // Enable the admin sign-up button
                $("#adminSignupFinalBtn").prop('disabled', false);
            } else {
                $("#errorMessage").removeClass("hidden");
            }
        });

        // Handle sign-up form submission (for both normal and admin)
        $("#signupForm").submit(function (e) {
            e.preventDefault(); // Prevent the default form submission

            let isValid = true;

            // Validate Full Name
            if (fullNameInput.val().trim() === "") {
                displayError(fullNameInput, "Please enter your full name.");
                isValid = false;
            } else if (fullNameInput.val().trim().length < 3 || fullNameInput.val().trim().length > 100) {
                displayError(fullNameInput, "Full name must be between 3 and 100 characters.");
                isValid = false;
            } else {
                clearError(fullNameInput);
            }

            // Validate Email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailInput.val().trim() === "") {
                displayError(emailInput, "Please enter your email address.");
                isValid = false;
            } else if (!emailRegex.test(emailInput.val().trim())) {
                displayError(emailInput, "Please enter a valid email address.");
                isValid = false;
            } else {
                clearError(emailInput);
            }

            // Validate Phone Number
            const phoneRegex = /^\d{10}$/;
            if (phoneInput.val().trim() === "") {
                displayError(phoneInput, "Please enter your phone number.");
                isValid = false;
            } else if (!phoneRegex.test(phoneInput.val().trim())) {
                displayError(phoneInput, "Phone number must be a 10-digit number.");
                isValid = false;
            } else {
                clearError(phoneInput);
            }

            // Validate Role
            if (roleSelect.val() === "") {
                displayError(roleSelect, "Please select a role.");
                isValid = false;
            } else {
                clearError(roleSelect);
            }

            // Validate Password
            if (passwordInput.val().trim() === "") {
                displayError(passwordInput, "Please enter your password.");
                isValid = false;
            } else if (passwordInput.val().trim().length < 6) {
                displayError(passwordInput, "Password must be at least 6 characters long.");
                isValid = false;
            } else {
                clearError(passwordInput);
            }

            // Validate Confirm Password
            if (confirmPasswordInput.val().trim() === "") {
                displayError(confirmPasswordInput, "Please confirm your password.");
                isValid = false;
            } else if (confirmPasswordInput.val().trim() !== passwordInput.val().trim()) {
                displayError(confirmPasswordInput, "Passwords do not match.");
                isValid = false;
            } else {
                clearError(confirmPasswordInput);
            }

            if (!isValid) {
                e.preventDefault(); // Prevent form submission if validation fails
                return;
            }

            let role = $("#role").val();
            let name = $("#fullName").val();
            let email = $("#email").val();
            let phone = $("#phone").val();
            let password = $("#password").val();
            let confirmPassword = $("#confirmPassword").val();

            // Validate password confirmation
            if (password !== confirmPassword) {
                alert("Passwords do not match!");
                return;
            }

            // Generate QR Code Data
            let userData = JSON.stringify({ email: email, password: password });
            $("#qrCode").html(""); // Clear old QR codes
            new QRCode($("#qrCode")[0], userData); // Generate the QR code

            // Wait for the QR code to be generated
            setTimeout(() => {
                // Get the QR code as a data URL
                let canvas = $("#qrCode canvas")[0];
                let qrCodeDataUrl = canvas.toDataURL("image/png");

                // Create the user object
                const user = {
                    fullName: name,
                    email: email,
                    phone: phone,
                    password: password,
                    role: role.toUpperCase(), // Ensure the role is uppercase
                    qrCode: qrCodeDataUrl // Include the QR code data URL
                };

                // Send AJAX request to the backend
                $.ajax({
                    url: "http://localhost:8080/api/v1/user/register",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(user),
                    success: function (response) {
                        alert("User registered successfully!");
                        if (response && response.data) {
                            let token = response.data.token;
                            console.log("Token:", token);
                            localStorage.setItem("authToken", token);
                            sessionStorage.setItem("authToken", token);
                        }
                        // Show the QR Code Modal
                        $("#qrCodeModal").css("display", "flex").hide().fadeIn().attr("aria-hidden", "false")
                    },
                    error: function (xhr) {
                        let errorMessage = "An error occurred";
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.statusText) {
                            errorMessage = xhr.statusText;
                        }
                        alert("Registration failed: " + errorMessage);
                    }
                });
            }, 100); // Wait for 100ms to ensure QR code is generated
        });

        // Admin final sign-up submission for the admin role
        $("#adminSignupFinalBtn").click(function (e) {
            e.preventDefault(); // Prevent default button behavior
            // Trigger the same form submission process for admin sign-up
            $("#signupForm").submit();
        });

        // QR Code Download Function
        function downloadQRCode() {
            let canvas = $("#qrCode canvas")[0];
            let img = canvas.toDataURL("image/png");

            let a = document.createElement("a"); // Create a temporary link
            a.href = img;
            a.download = "QRCode.png";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Attach download function to the button
        $("#downloadQR").click(downloadQRCode);


        // Toggle password visibility
        $("#showPassword").on("change", function() {
            let passwordField = $("#password");
            let confirmPasswordField = $("#confirmPassword");

            if ($(this).prop("checked")) {
                // Show password
                passwordField.attr("type", "text");
                confirmPasswordField.attr("type", "text");
            } else {
                // Hide password
                passwordField.attr("type", "password");
                confirmPasswordField.attr("type", "password");
            }
        });


    });
</script>

</body>
</html>